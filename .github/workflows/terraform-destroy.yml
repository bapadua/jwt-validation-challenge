name: Terraform Destroy

on:
  workflow_dispatch:  # Apenas execuÃ§Ã£o manual
    inputs:
      confirm_destroy:
        description: 'Digite "DESTROY" para confirmar a destruiÃ§Ã£o'
        required: true
        type: string
      force_import:
        description: 'Tentar importar recursos existentes antes de destruir?'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: '1.6.0'

jobs:
  terraform-destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ ConfirmaÃ§Ã£o incorreta. Digite exatamente 'DESTROY' para confirmar."
          exit 1
        fi
        echo "âœ… ConfirmaÃ§Ã£o vÃ¡lida. Procedendo com a destruiÃ§Ã£o..."
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        
    - name: Terraform Init
      run: |
        echo "ðŸ—ï¸ Initializing Terraform..."
        cd terraform/lambda-simple
        terraform init
        
    - name: Check AWS Resources
      run: |
        echo "ðŸ” Verificando recursos AWS existentes..."
        
        echo "=== Lambda Functions ==="
        aws lambda list-functions --query 'Functions[?contains(FunctionName, `jwt`)][FunctionName,Runtime,LastModified]' --output table 2>/dev/null || echo "Nenhuma funÃ§Ã£o Lambda encontrada"
        
        echo -e "\n=== Function URLs ==="
        LAMBDA_FUNCTIONS=$(aws lambda list-functions --query 'Functions[?contains(FunctionName, `jwt`)].FunctionName' --output text 2>/dev/null || echo "")
        for func in $LAMBDA_FUNCTIONS; do
          if [ -n "$func" ]; then
            echo "Verificando Function URL para: $func"
            aws lambda get-function-url-config --function-name "$func" --query '[FunctionUrl,AuthType]' --output text 2>/dev/null || echo "  Sem Function URL"
          fi
        done
        
    - name: Check Terraform State
      run: |
        echo "ðŸ“Š Verificando estado do Terraform..."
        cd terraform/lambda-simple
        echo "Recursos no estado:"
        terraform state list 2>/dev/null || echo "Estado vazio"
        
    - name: Import Resources (if requested)
      if: github.event.inputs.force_import == 'true'
      run: |
        echo "ðŸ“¥ Tentando importar recursos existentes..."
        cd terraform/lambda-simple
        
        # Verificar se jwt-validator existe
        if aws lambda get-function --function-name jwt-validator >/dev/null 2>&1; then
          echo "âœ… FunÃ§Ã£o jwt-validator encontrada. Importando..."
          terraform import aws_lambda_function.jwt_lambda jwt-validator || echo "âŒ Falha ao importar funÃ§Ã£o Lambda"
          
          # Importar Function URL se existir
          if aws lambda get-function-url-config --function-name jwt-validator >/dev/null 2>&1; then
            echo "âœ… Function URL encontrada. Importando..."
            terraform import aws_lambda_function_url.jwt_lambda_url jwt-validator || echo "âŒ Falha ao importar Function URL"
          fi
        else
          echo "âš ï¸ FunÃ§Ã£o jwt-validator nÃ£o encontrada para importar"
        fi
        
        echo "Estado apÃ³s import:"
        terraform state list
        
    - name: Terraform Plan Destroy
      run: |
        echo "ðŸ“‹ Planejando destruiÃ§Ã£o..."
        cd terraform/lambda-simple
        terraform plan -destroy -detailed-exitcode
      id: plan_destroy
      continue-on-error: true
      
    - name: Terraform Destroy
      run: |
        echo "ðŸ—‘ï¸ Destruindo infraestrutura..."
        cd terraform/lambda-simple
        
        # Se o Terraform plan funcionou e hÃ¡ recursos no estado, usar Terraform
        if [ "${{ steps.plan_destroy.outcome }}" = "success" ] && [ -n "$(terraform state list)" ]; then
          echo "ðŸŽ¯ Destruindo via Terraform..."
          terraform destroy -auto-approve
        else
          echo "âš ï¸ Estado Terraform vazio ou plan falhou. Usando AWS CLI..."
          
          # Remover jwt-validator especificamente
          if aws lambda get-function --function-name jwt-validator >/dev/null 2>&1; then
            echo "ðŸ—‘ï¸ Removendo Function URL..."
            aws lambda delete-function-url-config --function-name jwt-validator 2>/dev/null || echo "Function URL nÃ£o encontrada"
            
            echo "ðŸ—‘ï¸ Removendo Lambda Function jwt-validator..."
            aws lambda delete-function --function-name jwt-validator 2>/dev/null || echo "Falha ao remover funÃ§Ã£o"
          else
            echo "âš ï¸ FunÃ§Ã£o jwt-validator nÃ£o encontrada"
          fi
          
          # Remover outras funÃ§Ãµes JWT se existirem
          OTHER_FUNCTIONS=$(aws lambda list-functions --query 'Functions[?contains(FunctionName, `jwt`) && FunctionName != `jwt-validator`].FunctionName' --output text 2>/dev/null || echo "")
          for func in $OTHER_FUNCTIONS; do
            if [ -n "$func" ]; then
              echo "ðŸ—‘ï¸ Removendo funÃ§Ã£o adicional: $func"
              aws lambda delete-function-url-config --function-name "$func" 2>/dev/null || echo "Function URL nÃ£o encontrada"
              aws lambda delete-function --function-name "$func" 2>/dev/null || echo "Falha ao remover funÃ§Ã£o"
            fi
          done
        fi
        
    - name: Verify Cleanup
      run: |
        echo "ðŸ” Verificando se recursos foram removidos..."
        
        REMAINING_FUNCTIONS=$(aws lambda list-functions --query 'Functions[?contains(FunctionName, `jwt`)].FunctionName' --output text 2>/dev/null || echo "")
        
        if [ -z "$REMAINING_FUNCTIONS" ]; then
          echo "âœ… Todas as funÃ§Ãµes Lambda foram removidas com sucesso!"
        else
          echo "âŒ Ainda existem funÃ§Ãµes Lambda:"
          for func in $REMAINING_FUNCTIONS; do
            echo "  - $func"
            aws lambda get-function --function-name "$func" --query 'Configuration.[FunctionName,State,Runtime]' --output table 2>/dev/null || echo "Erro ao obter detalhes"
          done
        fi
        
    - name: Cleanup Summary
      run: |
        echo "## ðŸ—‘ï¸ Resumo da Limpeza" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verificar status final
        REMAINING_FUNCTIONS=$(aws lambda list-functions --query 'Functions[?contains(FunctionName, `jwt`)].FunctionName' --output text 2>/dev/null || echo "")
        
        if [ -z "$REMAINING_FUNCTIONS" ]; then
          echo "âœ… **Status**: Todos os recursos foram removidos com sucesso" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Lambda Functions**: Todas removidas" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Function URLs**: Todas removidas" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’° **Custo**: ~$0/mÃªs (recursos deletados)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status**: Alguns recursos ainda existem" >> $GITHUB_STEP_SUMMARY
          echo "**FunÃ§Ãµes restantes**: \`$REMAINING_FUNCTIONS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ PrÃ³ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar permissÃµes AWS" >> $GITHUB_STEP_SUMMARY
          echo "2. Executar novamente com \`force_import: true\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Verificar dependÃªncias no console AWS" >> $GITHUB_STEP_SUMMARY
        fi 